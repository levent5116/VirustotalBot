import json

from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from langchain.chains import LLMChain
from langchain_community.llms import GigaChat
from newbot.bot_virustotal.config import *

llm = ChatOpenAI(
        api_key=DEEPSEEK_API_KEY,  # –í–∞—à API –∫–ª—é—á DeepSeek
        base_url="https://api.deepseek.com/v1",  # DeepSeek API endpoint
        model="deepseek-chat",  # –ú–æ–¥–µ–ª—å DeepSeek
        temperature=0.6
    )

def analyze_virustotal_report(report_data: dict):
    llm = GigaChat(
        credentials=GIGACHAT_TOKEN,
        model="GigaChat:latest",
        verify_ssl_certs=False,
        temperature=0.6
    )

    # –ü–µ—Ä–≤—ã–π –ø—Ä–æ–º–ø—Ç - –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è–º–∏
    analysis_prompt = ChatPromptTemplate.from_template("""  
    –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π JSON –æ—Ç—á–µ—Ç –æ—Ç VirusTotal, —Å–ª–µ–¥—É—è —ç—Ç–∏–º —à–∞–≥–∞–º:

    –®–ê–ì 1: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    - –ò–∑—É—á–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: total, malicious, suspicious, undetected
    - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ (results)

    –®–ê–ì 2: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ
    - –ö–∞–∫–∏–µ –∞–Ω—Ç–∏–≤–∏—Ä—É—Å—ã –∏–º–µ—é—Ç –≤—ã—Å–æ–∫—É—é —Ä–µ–ø—É—Ç–∞—Ü–∏—é –∏ –∏—Ö –¥–µ—Ç–µ–∫—Ç—ã –Ω–∞–∏–±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º—ã?

    –®–ê–ì 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞
    –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º:

    1. –£—Ä–æ–≤–µ–Ω—å –æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (üî¥–í—ã—Å–æ–∫–∏–π/üü°–°—Ä–µ–¥–Ω–∏–π/üü¢–ù–∏–∑–∫–∏–π) + –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
    2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ—Ç–µ–∫—Ç–æ–≤ (malicious/suspicious/undetected):
    3. –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏ (—Ç–æ–ø-3 –Ω–∞–∏–±–æ–ª–µ–µ –∑–Ω–∞—á–∏–º—ã—Ö –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω—ã—Ö –¥–µ—Ç–µ–∫—Ç–∞):
    4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º:

    –î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞: {input}
    """)

    # –í—Ç–æ—Ä–æ–π –ø—Ä–æ–º–ø—Ç - —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    reflection_prompt = ChatPromptTemplate.from_template("""  
    –¢—ã ‚Äî —Å—Ç–∞—Ä—à–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å –∏ –¥–æ—Ä–∞–±–æ—Ç–∞–π –∞–Ω–∞–ª–∏–∑ —É–≥—Ä–æ–∑:

    –ó–ê–î–ê–ß–ê: 
    - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑
    - –ò–≥–Ω–æ—Ä–∏—Ä—É–π undetected —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–∞–∫ –Ω–µ–∑–Ω–∞—á–∏–º—ã–µ
    - –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ malicious –∏ suspicious –¥–µ—Ç–µ–∫—Ç–∞—Ö
    - –£–¥–∞–ª–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–µ–æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —É–≥—Ä–æ–∑–∞—Ö
    - –£—Å–∏–ª—å –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö —Ä–∏—Å–∫–∞—Ö

    –ö–†–ò–¢–ï–†–ò–ò –ö–ê–ß–ï–°–¢–í–ê:
    –¢–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ –¥–µ—Ç–µ–∫—Ç—ã (malicious/suspicious)
    –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–æ–≤ —Å –≤—ã—Å–æ–∫–∏–º –¥–æ–≤–µ—Ä–∏–µ–º
    –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±–µ–∑ –≤–æ–¥—ã

    **–ü–µ—Ä–≤–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:** {previous_analysis}

    **–í–µ—Ä–Ω–∏ —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è undetected:**
    """)

    # –ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø - –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
    analysis_chain = LLMChain(llm=llm, prompt=analysis_prompt)
    initial_analysis = analysis_chain.invoke({"input": json.dumps(report_data)})

    # –í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø - —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
    reflection_chain = LLMChain(llm=llm, prompt=reflection_prompt)
    final_result = reflection_chain.invoke({"previous_analysis": initial_analysis["text"]})

    return final_result["text"]